<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Data Uang Kas Driver Helper Delta 8</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { background-color: #f8f9fa; padding: 10px; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .judul-utama { color: #0d6efd; font-weight: bold; text-transform: uppercase; text-align: center; margin-bottom: 0; font-size: 1.1rem; }
        .sub-judul { color: #6c757d; font-size: 0.75rem; text-align: center; margin-bottom: 5px; }
        #sync-status { display: block; width: fit-content; margin: 0 auto 10px auto; font-size: 0.65rem; cursor: pointer; }
        
        /* PAKSA 1 BARIS DAN STICKY */
        .table { width: auto; min-width: 100%; white-space: nowrap; }
        .table th, .table td { vertical-align: middle; padding: 6px 4px !important; font-size: 0.75rem; overflow: hidden; text-overflow: ellipsis; }
        
        .no-col { position: sticky; left: 0; z-index: 11; background-color: #343a40 !important; color: white !important; width: 35px; min-width: 35px; text-align: center; border-right: 1px solid #454d55 !important; }
        .name-col { position: sticky; left: 35px; z-index: 10; background-color: #f0f8ff !important; width: 120px; min-width: 120px; font-weight: bold; border-right: 2px solid #dee2e6 !important; }
        td.no-col { background-color: #e9ecef !important; color: #333 !important; }

        .table-dark-header thead th { background-color: #343a40 !important; color: white !important; text-align: center; border: 1px solid #454d55; }
        .col-aksi { width: 35px; text-align: center; cursor: pointer; color: #0d6efd; background: #fff !important; font-weight: bold; }
        .col-rincian { background-color: #e9ecef !important; font-weight: bold; width: 60px; text-align: center; }
        .status-ok { background-color: #d4edda !important; text-align: center; cursor: pointer; width: 40px; font-size: 1rem; }
        .status-no { background-color: #f8d7da !important; text-align: center; cursor: pointer; width: 40px; font-size: 1rem; }
        
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-bottom: 5px; border-bottom: 2px solid #dee2e6; }
        .section-header h5 { margin: 0; font-weight: bold; font-size: 0.9rem; color: #495057; }
        .banner-rincian { background-color: #343a40; color: white; text-align: center; font-weight: bold; padding: 10px; border-radius: 5px; margin: 20px 0 10px 0; font-size: 0.85rem; }
        .box-saldo { color: white; padding: 8px; border-radius: 8px; text-align: center; font-weight: bold; font-size: 0.7rem; height: 100%; }
        .table-responsive { overflow-x: auto; border-radius: 5px; border: 1px solid #dee2e6; }
        
        .log-container { background: white; border-radius: 8px; border: 1px solid #dee2e6; padding: 8px; max-height: 150px; overflow-y: auto; font-size: 0.7rem; }
        .log-item { border-bottom: 1px solid #eee; padding: 4px 0; display: flex; justify-content: space-between; }
        .pin-input { font-size: 2rem !important; text-align: center; letter-spacing: 10px; font-weight: bold; border-radius: 12px; background: #f8f9fa; color: #0d6efd; }
        .exporting .admin-col, .exporting .btn-download-area, .exporting #sync-status, .exporting #log-section { display: none !important; }
    </style>
</head>
<body>

<div id="attendance-section" class="container-fluid">
    <div class="text-center">
        <h3 class="judul-utama">DATA UANG KAS DRIVER HELPER DELTA 8</h3>
        <p class="sub-judul">MONITORING DATA BULANAN</p>
        <span id="sync-status" class="badge bg-white text-muted border shadow-sm p-2 mb-2" onclick="loadFromCloud()">‚òÅÔ∏è Memuat data...</span>
    </div>

    <div class="section-header" style="border-bottom-color: #ffc107;">
        <h5>DATA DRIVER</h5>
        <div class="d-flex admin-col">
            <button class="btn btn-warning btn-sm fw-bold me-1 shadow-sm" style="font-size: 0.7rem;" onclick="askPIN('catat')">‚ûï Catat</button>
            <button class="btn btn-success btn-sm fw-bold shadow-sm" style="font-size: 0.7rem;" onclick="askPIN('tambah')">üë§ Tambah</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-bordered table-dark-header m-0">
            <thead>
                <tr><th class="no-col">NO</th><th class="name-col">NAMA</th><th>JAN</th><th>FEB</th><th>MAR</th><th>APR</th><th>MEI</th><th>JUN</th><th>JUL</th><th>AGU</th><th>SEP</th><th>OKT</th><th>NOV</th><th>DES</th><th class="col-rincian">TOT</th><th class="admin-col">...</th></tr>
            </thead>
            <tbody id="grid-driver"></tbody>
        </table>
    </div>

    <div class="section-header" style="border-bottom-color: #198754;"><h5>DATA HELPER</h5></div>
    <div class="table-responsive">
        <table class="table table-bordered table-dark-header m-0">
            <thead>
                <tr><th class="no-col">NO</th><th class="name-col">NAMA</th><th>JAN</th><th>FEB</th><th>MAR</th><th>APR</th><th>MEI</th><th>JUN</th><th>JUL</th><th>AGU</th><th>SEP</th><th>OKT</th><th>NOV</th><th>DES</th><th class="col-rincian">TOT</th><th class="admin-col">...</th></tr>
            </thead>
            <tbody id="grid-helper"></tbody>
        </table>
    </div>
</div>

<div id="financial-report-section" class="container-fluid">
    <div class="banner-rincian">RINCIAN UANG KAS DRIVER HELPER DELTA 8</div>
    <div class="btn-download-area mb-3"><button class="btn btn-danger btn-sm w-100 fw-bold py-2" onclick="downloadPDF()">üì• DOWNLOAD LAPORAN RINCIAN</button></div>
    <div class="row g-2 mb-3 admin-col text-center">
        <div class="col-6"><select class="form-select form-select-sm shadow-sm" id="selMonth" onchange="render()"></select></div>
        <div class="col-6"><select class="form-select form-select-sm shadow-sm" id="selYear" onchange="render()"></select></div>
    </div>
    <div class="row g-1 mb-4">
        <div class="col-6"><div class="box-saldo bg-secondary">SALDO AWAL: <span id="s-awal">0</span></div></div>
        <div class="col-6"><div class="box-saldo bg-info text-dark"> SALDO AKHIR: <span id="s-akhir">0</span></div></div>
        <div class="col-4"><div class="box-saldo bg-success">PEMASUKAN: <span id="in">0</span></div></div>
        <div class="col-4"><div class="box-saldo bg-danger">PENGELUARAN: <span id="out">0</span></div></div>
        <div class="col-4"><div class="box-saldo bg-primary">TOTAL SALDO: <span id="bal">0</span></div></div>
    </div>
    <div class="table-responsive shadow-sm">
        <table class="table table-bordered table-striped m-0 text-center">
            <thead class="table-primary"><tr><th>TANGGAL</th><th>TIPE</th><th>SUMBER/PENERIMA</th><th>KETERANGAN</th><th>NOMINAL</th><th class="admin-col">...</th></tr></thead>
            <tbody id="hist"></tbody>
        </table>
    </div>
</div>

<div id="log-section" class="container-fluid mb-5 mt-4"><h6 class="fw-bold text-muted small">üïí LOG AKTIVITAS</h6><div class="log-container shadow-sm" id="log-list"></div></div>

<div class="modal fade" id="modalVerifyPIN" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-body p-4 text-center"><p class="fw-bold small mb-3">PIN AKSES</p><input type="password" id="inputPIN" class="form-control pin-input mb-3" inputmode="numeric" maxlength="4" oninput="if(this.value.length==4)checkPIN()"><div class="d-flex justify-content-center gap-2"><button class="btn btn-light btn-sm" data-bs-dismiss="modal">Batal</button><button class="btn btn-primary btn-sm px-4" onclick="checkPIN()">OK</button></div></div></div></div></div>

<div class="modal fade" id="modalMenu" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-body p-0 text-center"><div class="list-group list-group-flush"><div class="list-group-item small fw-bold bg-light" id="menuLabel"></div><button class="list-group-item list-group-item-action py-3 text-primary fw-bold" onclick="askPIN('edit')">‚úèÔ∏è EDIT</button><button class="list-group-item list-group-item-action py-3 text-danger fw-bold" onclick="askPIN('hapus')">üóëÔ∏è HAPUS</button><button class="list-group-item list-group-item-action py-2 small" data-bs-dismiss="modal">Tutup</button></div></div></div></div></div>

<div class="modal fade" id="modalTambah" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form id="fAdd"><div class="modal-header"><b>Tambah Anggota</b></div><div class="modal-body"><input type="text" id="n" class="form-control mb-2" placeholder="Nama" required><select id="k" class="form-select"><option value="Driver">Driver</option><option value="Helper">Helper</option></select></div><div class="modal-footer"><button type="submit" class="btn btn-primary w-100">SIMPAN</button></div></form></div></div></div>
<div class="modal fade" id="modalCatat" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form id="fTrans"><div class="modal-header"><b>Catat Transaksi</b></div><div class="modal-body"><select name="tp" class="form-select mb-2"><option value="Pemasukan">Pemasukan</option><option value="Pengeluaran">Pengeluaran</option></select><input type="date" name="d" class="form-control mb-2" required><input type="text" name="p" class="form-control mb-2" placeholder="Sumber/Penerima" required><input type="text" name="k" class="form-control mb-2" placeholder="Keterangan" required><input type="number" name="v" class="form-control" placeholder="Nominal" required></div><div class="modal-footer"><button type="submit" class="btn btn-warning w-100">SIMPAN</button></div></form></div></div></div>
<div class="modal fade" id="modalEditTrans" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><b>Edit Transaksi</b></div><div class="modal-body"><select id="etTp" class="form-select mb-2"><option value="Pemasukan">Pemasukan</option><option value="Pengeluaran">Pengeluaran</option></select><input type="date" id="etD" class="form-control mb-2"><input type="text" id="etP" class="form-control mb-2"><input type="text" id="etK" class="form-control mb-2"><input type="number" id="etV" class="form-control"></div><div class="modal-footer"><button class="btn btn-warning w-100" onclick="saveEditTrans()">UPDATE</button></div></div></div></div>
<div class="modal fade" id="modalEditAnggota" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><b>Edit Anggota</b></div><div class="modal-body"><input type="text" id="eName" class="form-control mb-2"><select id="eKat" class="form-select"><option value="Driver">Driver</option><option value="Helper">Helper</option></select></div><div class="modal-footer"><button class="btn btn-primary w-100" onclick="saveEditAnggota()">SIMPAN</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const CLOUD_URL = 'https://script.google.com/macros/s/AKfycbzureBi1LFx9zLcC93-FfqhGk7wzPNttTyzCs_lsqf5WZx0YD75X7xlj5EAL7M8T75itQ/exec'; 
    const APP_PIN = "0000"; 
    let DB_DRIVER = [], DB_HELPER = [], DB_TRANSAKSI = [], DB_LOGS = [], nextId = 1;
    let currentSelection = null, pendingAction = null, pendingParams = null;

    // FIX FUNGSI ASK PIN: Tutup modal menu dengan benar sebelum buka PIN
    function askPIN(type, params = null) { 
        pendingAction = type; 
        pendingParams = params; 

        // Tutup modal menu jika ada instance yang sedang aktif
        const menuModalEl = document.getElementById('modalMenu');
        const menuModalInstance = bootstrap.Modal.getInstance(menuModalEl);
        if (menuModalInstance) menuModalInstance.hide();

        // Reset input PIN
        document.getElementById('inputPIN').value = ""; 
        
        // Berikan jeda transisi 200ms agar backdrop tidak macet
        setTimeout(() => {
            const pinModal = new bootstrap.Modal(document.getElementById('modalVerifyPIN'));
            pinModal.show();
        }, 200);
    }

    function checkPIN() {
        if (document.getElementById('inputPIN').value === APP_PIN) {
            const pinModalEl = document.getElementById('modalVerifyPIN');
            bootstrap.Modal.getInstance(pinModalEl).hide();
            
            // Jalankan aksi setelah modal PIN tertutup sepenuhnya
            setTimeout(() => {
                if (pendingAction === 'tambah') new bootstrap.Modal(document.getElementById('modalTambah')).show();
                else if (pendingAction === 'catat') new bootstrap.Modal(document.getElementById('modalCatat')).show();
                else if (pendingAction === 'edit') handleEdit();
                else if (pendingAction === 'hapus') handleHapus();
                else if (pendingAction === 'toggle') processToggle(pendingParams.id, pendingParams.kat, pendingParams.y, pendingParams.m);
                pendingAction = null;
            }, 300);
        } else {
            alert("PIN SALAH!");
            document.getElementById('inputPIN').value = "";
        }
    }

    function handleEdit() {
        if(currentSelection.tipe === 'Transaksi') {
            let t = DB_TRANSAKSI[currentSelection.id];
            document.getElementById('etTp').value = t.tp; 
            document.getElementById('etD').value = t.d; 
            document.getElementById('etP').value = t.p; 
            document.getElementById('etK').value = t.k; 
            document.getElementById('etV').value = t.v;
            new bootstrap.Modal(document.getElementById('modalEditTrans')).show();
        } else {
            let p = (currentSelection.tipe === 'Driver' ? DB_DRIVER : DB_HELPER).find(x => x.id === currentSelection.id);
            document.getElementById('eName').value = p.nama; 
            document.getElementById('eKat').value = currentSelection.tipe;
            new bootstrap.Modal(document.getElementById('modalEditAnggota')).show();
        }
    }

    // FUNGSI LAINNYA TETAP SAMA
    function addLog(msg) {
        const timeStr = new Date().toLocaleString('id-ID', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'});
        DB_LOGS.unshift({ time: timeStr, msg }); if(DB_LOGS.length > 300) DB_LOGS.pop();
    }

    async function loadFromCloud() {
        const st = document.getElementById('sync-status'); st.innerText = "‚òÅÔ∏è Memuat...";
        try {
            const res = await fetch(CLOUD_URL + "?action=read");
            const data = await res.json();
            DB_DRIVER = data.driver || []; DB_HELPER = data.helper || [];
            DB_TRANSAKSI = data.transaksi || []; DB_LOGS = data.logs || [];
            nextId = Math.max(...[...DB_DRIVER, ...DB_HELPER].map(x=>x.id), 0) + 1;
            render(); st.innerText = "‚òÅÔ∏è Terkoneksi";
        } catch (e) { st.innerText = "‚òÅÔ∏è Offline"; }
    }

    async function syncAll() {
        localStorage.setItem('D8_DB_FINAL', JSON.stringify({driver:DB_DRIVER, helper:DB_HELPER, transaksi:DB_TRANSAKSI, logs:DB_LOGS, nextId}));
        try { await fetch(CLOUD_URL, { method: 'POST', body: JSON.stringify({ driver: DB_DRIVER, helper: DB_HELPER, transaksi: DB_TRANSAKSI, logs: DB_LOGS }) }); } catch (e) {}
    }

    function render() {
        const gd = document.getElementById('grid-driver'), gh = document.getElementById('grid-helper'), hi = document.getElementById('hist'), lg = document.getElementById('log-list');
        gd.innerHTML = gh.innerHTML = hi.innerHTML = lg.innerHTML = '';
        const m = parseInt(document.getElementById('selMonth').value), y = parseInt(document.getElementById('selYear').value);
        let sAwal = calculatePastBalance(m, y), cIn = 0, cOut = 0;

        const draw = (list, target, kat) => {
            list.forEach((p, idx) => {
                let lunasCount = 0;
                let row = `<td class="no-col">${idx + 1}</td><td class="name-col">${p.nama}</td>`;
                for(let i=1; i<=12; i++) {
                    let s = p.status?.[y]?.[i] || false;
                    if(s) { lunasCount++; if(i === m) cIn += 25000; }
                    row += `<td class="${s?'status-ok':'status-no'}" onclick="askPIN('toggle', {id:${p.id}, kat:'${kat}', y:${y}, m:${i}})">${s?'‚úÖ':'‚ùå'}</td>`;
                }
                row += `<td class="col-rincian">${lunasCount}/12</td><td class="col-aksi admin-col" onclick="askAction(${p.id},'${kat}','${p.nama}')">‚ãÆ</td>`;
                let tr = document.createElement('tr'); tr.innerHTML = row; target.appendChild(tr);
            });
        };
        draw(DB_DRIVER, gd, 'Driver'); draw(DB_HELPER, gh, 'Helper');

        DB_TRANSAKSI.filter(x => { let d = new Date(x.d); return d.getFullYear() === y && (d.getMonth() + 1) === m;
        }).forEach((x, idx) => {
            if(x.tp === 'Pemasukan') cIn += x.v; else cOut += x.v;
            hi.innerHTML += `<tr><td>${x.d.split('-').reverse().join('/')}</td><td>${x.tp}</td><td>${x.p}</td><td>${x.k}</td><td>${x.v.toLocaleString()}</td><td class="col-aksi admin-col" onclick="askAction(${idx},'Transaksi','${x.k}')">‚ãÆ</td></tr>`;
        });

        DB_LOGS.filter(l => l.time.includes(`/${m.toString().padStart(2,'0')}/${y}`)).forEach(l => lg.innerHTML += `<div class="log-item"><span>${l.time}</span><span>${l.msg}</span></div>`);

        document.getElementById('s-awal').innerText = sAwal.toLocaleString('id-ID');
        document.getElementById('in').innerText = cIn.toLocaleString('id-ID');
        document.getElementById('out').innerText = cOut.toLocaleString('id-ID');
        document.getElementById('bal').innerText = (sAwal + cIn - cOut).toLocaleString('id-ID');
        document.getElementById('s-akhir').innerText = (sAwal + cIn - cOut).toLocaleString('id-ID');
    }

    function calculatePastBalance(m, y) {
        let totalIn = 0, totalOut = 0;
        [...DB_DRIVER, ...DB_HELPER].forEach(p => { if(p.status) Object.keys(p.status).forEach(sy => { Object.keys(p.status[sy]).forEach(sm => { if (parseInt(sy) < y || (parseInt(sy) == y && parseInt(sm) < m)) if(p.status[sy][sm]) totalIn += 25000; }); }); });
        DB_TRANSAKSI.forEach(x => { let d = new Date(x.d); if (d.getFullYear() < y || (d.getFullYear() == y && (d.getMonth() + 1) < m)) if(x.tp === 'Pemasukan') totalIn += x.v; else totalOut += x.v; });
        return totalIn - totalOut;
    }

    function processToggle(id, kat, y, m) {
        let p = (kat === 'Driver' ? DB_DRIVER : DB_HELPER).find(x => x.id === id);
        if(!p.status) p.status = {}; if(!p.status[y]) p.status[y] = {};
        p.status[y][m] = !p.status[y][m]; addLog(`${p.nama} ${m}/${y}: ${p.status[y][m]?'Lunas':'Hapus'}`); syncAll(); render();
    }

    document.getElementById('fAdd').onsubmit = (e) => {
        e.preventDefault();
        let p = { id: nextId++, nama: document.getElementById('n').value, status: {} };
        if(document.getElementById('k').value === 'Driver') DB_DRIVER.push(p); else DB_HELPER.push(p);
        addLog(`‚ûï Anggota: ${p.nama}`); syncAll(); render(); bootstrap.Modal.getInstance(document.getElementById('modalTambah')).hide();
    };

    document.getElementById('fTrans').onsubmit = (e) => {
        e.preventDefault(); const f = new FormData(e.target);
        DB_TRANSAKSI.push({ tp: f.get('tp'), d: f.get('d'), p: f.get('p'), k: f.get('k'), v: parseInt(f.get('v')) });
        addLog(`üí∞ ${f.get('tp')}: ${f.get('k')}`); syncAll(); render(); bootstrap.Modal.getInstance(document.getElementById('modalCatat')).hide();
    };

    function askAction(id, tipe, label) { 
        currentSelection = { id, tipe, label }; 
        document.getElementById('menuLabel').innerText = label; 
        const m = new bootstrap.Modal(document.getElementById('modalMenu'));
        m.show(); 
    }

    function saveEditAnggota() {
        let nKat = document.getElementById('eKat').value, oldList = currentSelection.tipe === 'Driver' ? DB_DRIVER : DB_HELPER;
        let p = oldList.find(x => x.id === currentSelection.id); p.nama = document.getElementById('eName').value;
        if(nKat !== currentSelection.tipe) {
            let idx = oldList.findIndex(x => x.id === currentSelection.id);
            let data = oldList.splice(idx, 1)[0]; if(nKat === 'Driver') DB_DRIVER.push(data); else DB_HELPER.push(data);
        }
        addLog(`‚úèÔ∏è Edit: ${p.nama}`); syncAll(); render(); bootstrap.Modal.getInstance(document.getElementById('modalEditAnggota')).hide();
    }

    function saveEditTrans() {
        let t = DB_TRANSAKSI[currentSelection.id];
        t.tp = document.getElementById('etTp').value; t.d = document.getElementById('etD').value; t.p = document.getElementById('etP').value; t.k = document.getElementById('etK').value; t.v = parseInt(document.getElementById('etV').value);
        addLog(`‚úèÔ∏è Edit Trans: ${t.k}`); syncAll(); render(); bootstrap.Modal.getInstance(document.getElementById('modalEditTrans')).hide();
    }

    function handleHapus() {
        if(currentSelection.tipe === 'Transaksi') DB_TRANSAKSI.splice(currentSelection.id, 1);
        else if(currentSelection.tipe === 'Driver') DB_DRIVER = DB_DRIVER.filter(x => x.id !== currentSelection.id);
        else DB_HELPER = DB_HELPER.filter(x => x.id !== currentSelection.id);
        addLog(`üóëÔ∏è Hapus: ${currentSelection.label}`); syncAll(); render(); 
    }

    function downloadPDF() {
        const element = document.getElementById('financial-report-section');
        const bulan = document.getElementById('selMonth').options[document.getElementById('selMonth').selectedIndex].text;
        document.body.classList.add('exporting');
        html2pdf().set({ margin: 10, filename: `Kas_D8_${bulan}.pdf`, html2canvas: { scale: 2 }, jsPDF: { format: 'a4', orientation: 'portrait' } }).from(element).save().then(() => { document.body.classList.remove('exporting'); });
    }

    window.onload = () => {
        const sm = document.getElementById('selMonth'), sy = document.getElementById('selYear'), now = new Date();
        const names = ["","Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
        for(let i=1; i<=12; i++) sm.innerHTML += `<option value="${i}" ${i===(now.getMonth()+1)?'selected':''}>${names[i]}</option>`;
        for(let i=2024; i<=2050; i++) sy.innerHTML += `<option value="${i}" ${i===now.getFullYear()?'selected':''}>${i}</option>`;
        loadFromCloud();
    };
</script>
</body>
</html>
