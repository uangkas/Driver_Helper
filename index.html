<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Data Uang KAS Driver Helper DELTA 8</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --bg-body: #0a0a0a;
            --bg-card: #151515;
            --text-main: #ffffff;
            --accent-color: #d4af37;
            --border-color: #2a2a2a;
            --sticky-bg: #151515;
            --gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728);
            --log-bg: #151515;
            --text-muted: #888888;
            --input-bg: #1a1a1a;
            --card-inner: #1a1a1a;
        }

        [data-theme="emerald"] {
            --bg-body: #05140f; --bg-card: #0a1f18; --text-main: #ffffff; --accent-color: #10b981; --border-color: #064e3b;
            --sticky-bg: #0a1f18; --gradient: linear-gradient(135deg, #064e3b, #10b981, #065f46);
            --log-bg: #0a1f18; --text-muted: #94a3b8; --input-bg: #0d2b22; --card-inner: #0d2b22;
        }

        [data-theme="platinum"] {
            --bg-body: #f8fafc; --bg-card: #ffffff; --text-main: #1e293b; --accent-color: #475569; --border-color: #e2e8f0;
            --sticky-bg: #ffffff; --gradient: linear-gradient(135deg, #475569, #94a3b8, #64748b);
            --log-bg: #ffffff; --text-muted: #64748b; --input-bg: #f1f5f9; --card-inner: #f1f5f9;
        }

        [data-theme="crystal"] {
            --bg-body: #f0f9ff; --bg-card: #ffffff; --text-main: #0c4a6e; --accent-color: #0284c7; --border-color: #bae6fd;
            --sticky-bg: #ffffff; --gradient: linear-gradient(135deg, #0369a1, #0ea5e9, #0284c7);
            --log-bg: #ffffff; --text-muted: #0ea5e9; --input-bg: #0e f2fe; --card-inner: #e0f2fe;
        }

        * { font-family: "Times New Roman", Times, serif !important; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            padding: 15px;
            overflow-x: hidden;
            transition: 0.3s;
        }

        .judul-utama {
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
            text-align: center;
            font-size: 1.1rem;
            letter-spacing: 0px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .table-responsive {
            background: var(--accent-color);
            border-radius: 12px;
            border: 1px solid var(--accent-color);
            margin-bottom: 15px;
            overflow: auto;
            max-height: 70vh;
        }

        .table {
            margin-bottom: 0;
            color: var(--text-main);
            min-width: 900px;
            white-space: nowrap;
            border-color: var(--accent-color);
            border-collapse: separate;
            border-spacing: 0.5px;
            border-radius: 6px;
            table-layout: fixed;
        }

        .table tbody tr td {
            background-color: var(--bg-card) !important;
            color: var(--text-main);
            border-radius: 6px;
        }

        .table thead th {
            position: sticky;
            top: 0;
            z-index: 25;
            background: var(--gradient) !important;
            color: #000000 !important;
            font-size: 0.85rem !important;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            vertical-align: middle;
            text-align: center !important;
            border-radius: 6px !important;
            height: 46px !important;
            padding-top: 5px !important;
        }

        .no-col { width: 45px !important; height: 45px; position: sticky !important; left: 0; z-index: 10; background-color: var(--bg-card) !important; color: var(--text-main) !important; font-size: 0.75rem !important; font-weight: 800; text-align: center; vertical-align: middle !important; border-radius: 7px; }
        .name-col { width: 180px !important; position: sticky !important; left: 45px; z-index: 9; background-color: var(--accent-color) !important; color: var(--text-main) !important; font-size: 0.75rem !important; font-weight: 700 !important; text-transform: uppercase; vertical-align: middle !important; padding-left: 12px !important; border-right: 2px solid var(--accent-color) !important; border-left: 2px solid var(--accent-color) !important; border-radius: 7px; }

        .status-toggle { background: var(--accent-color); width: 60px !important; border-radius: 7px; text-align: center; vertical-align: middle; cursor: pointer; }
        .text-center-force { font-size: 15px; color: var(--text-main) !important; text-align: center; border-radius: 6px; vertical-align: middle !important; width: 60px !important; }

        thead th.no-col { z-index: 40 !important; top: 0; left: 0; background: var(--gradient) !important; }
        thead th.name-col { z-index: 39 !important; top: 0; left: 45px; background: var(--gradient) !important; }

        #table-transaksi, #log-list-table { 
            border-collapse: separate !important; border-spacing: 2px 2px; table-layout: fixed; width: 100%; min-width: 800px; border: none; 
        }
        
        #table-transaksi thead th, #log-list-table thead th { 
            height: 40px !important; text-align: center !important; font-size: 0.8rem !important; padding-top: 5px !important;
            position: sticky; top: 0; z-index: 10;
        }

        .col-tgl { width: 85px !important; }
        .col-tip { width: 120px !important; }
        .col-sum { width: 200px !important; }
        .col-ket { width: 210px !important; }
        .col-nom { width: 120px !important; }
        .col-aks { width: 45px !important; }

        #table-transaksi tbody td, #log-list-table tbody td {
            height: 20px !important; 
            line-height: 1.1 !important;
            border-radius: 4px;
            border-bottom: 1px solid var(--accent-color) !important;
            padding: 2px 8px !important;
            font-size: 0.75rem !important;
            vertical-align: middle !important;
            background-color: var(--bg-card) !important;
            white-space: nowrap !important;
            color: var(--text-main) !important;
        }

        .transaksi-scroll-area {
            max-height: 400px; 
            overflow-y: auto;
            border-radius: 12px;
            background: var(--accent-color);
            padding: 1px;
        }

        ::placeholder { color: var(--text-main) !important; opacity: 1 !important; }
        .form-control::placeholder { color: var(--text-main) !important; }
        .form-control { background-color: var(--input-bg, #1a1a1a) !important; color: var(--text-main) !important; border: 1px solid var(--accent-color) !important; }
        .modal-content { background: var(--bg-card); border: 2px solid var(--accent-color); color: var(--text-main); border-radius: 15px; }

        #log-list-table { table-layout: auto !important; }
        
        .col-aksi-center { text-align: center !important; vertical-align: middle !important; padding: 0 !important; width: 30px; border-radius: 6px !important; }
        .btn-aksi-trigger { cursor: pointer; color: var(--text-main); font-weight: bold; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; background: transparent !important; }
        
        .fleet-header-wrapper { margin-top: 30px; margin-bottom: 10px; }
        .panel-kanan { display: flex; align-items: center; width: 100%; justify-content: space-between; gap: 10px; }
        .select-group-mini { display: flex; gap: 2px; background: transparent; padding: 2px 8px; border-radius: 8px; border: 1px solid var(--accent-color); height: 36px; align-items: center; }
        .custom-select-mini { background: transparent; color: var(--accent-color); border: none; font-size: 0.75rem; font-weight: 900; cursor: pointer; outline: none; text-transform: uppercase; }
        .btn-luxe { color: var(--accent-color); background: transparent; font-size: 0.7rem !important; font-weight: 900 !important; height: 36px; padding: 0 10px !important; border-radius: 8px !important; border: 1px solid var(--accent-color); letter-spacing: 0.5px; white-space: nowrap; }
        .btn-unduh-final { width: 100%; background: var(--gradient); color: #000; font-weight: 900; border: none; padding: 12px; border-radius: 8px; text-transform: uppercase; font-size: 0.85rem; margin-bottom: 8px; }
        .btn-hapus-final { width: 100%; background: transparent; color: #ff4d4d; border: 1px solid #ff4d4d; font-weight: bold; padding: 8px; border-radius: 8px; font-size: 0.75rem; }
        .label-armada { font-weight: 900; color: var(--accent-color); margin: 15px 0 5px 0; display: block; width: 100%; }
        .card-saldo { background: var(--card-inner); border: 1px solid var(--accent-color); border-radius: 12px; padding: 12px 8px; text-align: center; min-height: 80px; display: flex; flex-direction: column; justify-content: center; }
        .card-saldo .label { font-size: 0.6rem; font-weight: 900; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
        .card-saldo .value { font-size: 0.85rem; font-weight: 900; color: var(--text-main); }
        .theme-dot { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(128, 128, 128, 0.3); }
        .theme-dot.active { border: 2px solid var(--text-main); transform: scale(1.1); box-shadow: 0 0 10px var(--accent-color); }
        .luxe-dropdown { width: 100%; background: var(--bg-card); border: 1px solid var(--accent-color); color: var(--accent-color); padding: 12px 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: bold; margin-top: 15px; }
        .luxe-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; background: var(--bg-card); border-radius: 0 0 12px 12px; margin-top: -10px; }
        .luxe-content.show { max-height: 800px; border: 1px solid var(--accent-color); border-top: none; padding: 12px 1px 1px 1px; }
        .banner-bar { background: var(--gradient); color: #000; padding: 10px; border-radius: 8px; font-weight: 900; text-align: center; margin: 30px 0 15px 0; font-size: 0.85rem; letter-spacing: 2px; }
        
        #actionMenu { display: none; position: absolute; z-index: 99999; background: var(--bg-card); border: 1px solid var(--accent-color); border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); min-width: 110px; overflow: hidden; }
        .menu-item { padding: 10px 15px; cursor: pointer; font-size: 0.85rem; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
                .footer-app {
            margin-top: 40px;
            padding: 40px 0;
            text-align: center;
            border-top: 1px solid var(--border-color);
            
            /* Gradasi dari atas ke bawah selaras dengan tema */
            background: linear-gradient(to bottom, 
                transparent 0%, 
                var(--bg-card) 40%, 
                var(--bg-body) 100%);
            
            /* Membuat background mentok ke ujung layar */
            width: 100vw;
            position: relative;
            left: 50%;
            right: 50%;
            margin-left: -50vw;
            margin-right: -50vw;
        }

        .footer-logo {
            font-weight: 900;
            letter-spacing: 6px;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.1rem;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .footer-divider {
            width: 100px;
            height: 2px;
            background: var(--gradient);
            margin: 2px auto;
            border-radius: 2px;
        }

        .footer-tagline {
            font-size: 0.75rem;
            color: var(--accent-color);
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: 700;
            margin-bottom: 1px;
        }

        .footer-info {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            line-height: 2;
            max-width: 600px;
            margin: 0 auto;
        }

        .copyright-text {
            margin-top: 2px;
            font-size: 0.6rem;
            color: var(--accent-color);
            opacity: 0.6;
            letter-spacing: 1px;
        }


    </style>
</head>

<body data-theme="luxury">
    <div class="container-fluid" id="app-content">
        <div id="header-section" class="text-center pt-4 pb-1">
            <h3 class="judul-utama">DATA UANG KAS DRIVER HELPER DELTA 8</h3>
            <p id="sync-status" class="small fw-bold" style="color: var(--text-muted); letter-spacing: 3px; margin: 0;">‚òÅÔ∏è MENGHUBUNGKAN...</p>
            <div class="theme-container d-flex justify-content-center gap-3 mt-3">
                <div id="dot-luxury" class="theme-dot active" style="background: #d4af37;" onclick="setTheme('luxury')"></div>
                <div id="dot-emerald" class="theme-dot" style="background: #10b981;" onclick="setTheme('emerald')"></div>
                <div id="dot-platinum" class="theme-dot" style="background: #64748b;" onclick="setTheme('platinum')"></div>
                <div id="dot-crystal" class="theme-dot" style="background: #0ea5e9;" onclick="setTheme('crystal')"></div>
            </div>
        </div>

        <div id="fleet-area">
            <div class="fleet-header-wrapper">
                <div class="panel-kanan">
                    <div class="select-group-mini">
                        <select id="selMonth" class="custom-select-mini" onchange="render()"></select>
                        <span style="color: var(--border-color); opacity: 0.5;">|</span>
                        <select id="selYear" class="custom-select-mini" onchange="render()"></select>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn-luxe" onclick="askAuth('catat')">+ TRANSAKSI</button>
                        <button class="btn-luxe" onclick="askAuth('tambah')">+ ANGGOTA</button>
                    </div>
                </div>
                <h6 class="label-armada">| DATA DRIVER</h6>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th class="no-col">NO</th><th class="name-col">NAMA ANGGOTA</th>
                            <th>JAN</th><th>FEB</th><th>MAR</th><th>APR</th><th>MEI</th><th>JUN</th>
                            <th>JUL</th><th>AGU</th><th>SEP</th><th>OKT</th><th>NOV</th><th>DES</th>
                            <th class="text-center-force">TOTAL</th><th class="text-center-force">AKSI</th>
                        </tr>
                    </thead>
                    <tbody id="grid-driver"></tbody>
                </table>
            </div>

            <h6 class="label-armada px-1">| DATA HELPER</h6>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th class="no-col">NO</th><th class="name-col">NAMA ANGGOTA</th>
                            <th>JAN</th><th>FEB</th><th>MAR</th><th>APR</th><th>MEI</th><th>JUN</th>
                            <th>JUL</th><th>AGU</th><th>SEP</th><th>OKT</th><th>NOV</th><th>DES</th>
                            <th class="text-center-force">TOTAL</th><th class="text-center-force">AKSI</th>
                        </tr>
                    </thead>
                    <tbody id="grid-helper"></tbody>
                </table>
            </div>
        </div>

        <div class="banner-bar">LAPORAN KEUANGAN BULANAN</div>
        <div id="financial-area">
            <div class="row g-2 mb-4">
                <div class="col-6 col-md-3"><div class="card-saldo"><div class="label">Saldo Awal</div><div id="s-awal" class="value">0</div></div></div>
                <div class="col-6 col-md-3"><div class="card-saldo"><div class="label">Saldo Akhir</div><div id="s-akhir" class="value" style="color:var(--accent-color)">0</div></div></div>
                <div class="col-4 col-md-2"><div class="card-saldo"><div class="label">Iuran</div><div id="in" class="value text-success">0</div></div></div>
                <div class="col-4 col-md-2"><div class="card-saldo"><div class="label">Saldo Keluar</div><div id="out" class="value text-danger">0</div></div></div>
                <div class="col-4 col-md-2"><div class="card-saldo"><div class="label">Lainnya</div><div id="bal" class="value">0</div></div></div>
            </div>

            <div class="transaksi-scroll-area">
                <table class="table" id="table-transaksi">
                    <thead>
                        <tr>
                            <th class="col-tgl">TANGGAL</th><th class="col-tip">TIPE</th><th class="col-sum">SUMBER</th>
                            <th class="col-ket">KETERANGAN</th><th class="col-nom">NOMINAL</th><th class="col-aks">AKSI</th>
                        </tr>
                    </thead>
                    <tbody id="hist"></tbody>
                </table>
            </div>
        </div>

        <div id="system-area">
            <div class="luxe-dropdown" onclick="toggleCol('log-col')"><span>üïí LOG AKTIVITAS SISTEM</span><span id="log-icon">‚ñº</span></div>
            <div id="log-col" class="luxe-content">
                <div class="table-responsive" style="max-height: 300px;">
                    <table class="table" id="log-list-table">
                        <thead><tr><th style="width: 100px;">WAKTU</th><th style="width: 100px;">EDITOR</th><th style="width: 100px;">AKSI</th><th>KETERANGAN</th></tr></thead>
                        <tbody id="log-list"></tbody>
                    </table>
                </div>
            </div>

            <div class="luxe-dropdown" onclick="toggleCol('export-col')"><span>üì§ DOWNLOAD PDF & HAPUS LOG</span><span id="export-icon">‚ñº</span></div>
            <div id="export-col" class="luxe-content">
                <button class="btn-unduh-final" onclick="askAuth('download')">üì• UNDUH LAPORAN PDF</button>
                <button class="btn-hapus-final" onclick="clearLogs()">HAPUS SEMUA LOG SISTEM</button>
            </div>
        </div>
        <footer class="footer-app">
            <div class="footer-logo">DRIVER HELPER DELTA 8</div>
            <div class="footer-tagline">Excellence in Logistics</div>
            <div class="footer-divider"></div>
            
            <div class="footer-info">Sistem Manajemen Uang KAS Driver Helper</div>
            <div class="copyright-text">
                &copy; 2026 ALL MANAGEMENT MEMBERS.
            </div>
            <div style="margin-top: 10px;">
                <strong style="font-size: 8px; color: var(--accent-color); letter-spacing: 2px;">
                    ---<{SUPPORTED BY : MANCUNG_168}>---
                </strong>
            </div>
        </footer>

    </div>

    <div id="actionMenu">
        <div class="menu-item p-2 px-3" onclick="doEdit()">‚úèÔ∏è Edit</div>
        <div class="menu-item p-2 px-3 text-danger" onclick="doDelete()">üóëÔ∏è Hapus</div>
    </div>

    <div class="modal fade" id="modalVerifyAuth" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body p-4 text-center"><h6 class="fw-bold mb-3">VERIFIKASI OTORITAS</h6><input type="text" id="inputEditorName" class="form-control mb-2 text-center" placeholder="Nama Editor"><input type="password" id="inputPIN" class="form-control mb-3 text-center" maxlength="4" placeholder="PIN" inputmode="numeric" oninput="checkAuth()"></div></div></div></div>
    
    <div class="modal fade" id="modalCatat" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body"><h6 class="fw-bold mb-3">CATAT TRANSAKSI</h6><form id="fTrans"><input type="hidden" id="editTransIdx"><select name="tp" id="trans_type" class="form-select mb-2"><option value="Pemasukan">Pemasukan</option><option value="Pengeluaran" selected>Pengeluaran</option></select><input type="date" name="d" id="trans_date" class="form-control mb-2" required><input type="text" name="p" id="trans_source" class="form-control mb-2" placeholder="Sumber/Penerima"><input type="text" name="k" id="trans_ket" class="form-control mb-2" placeholder="Keterangan"><input type="number" name="v" id="trans_val" class="form-control mb-3" placeholder="Nominal" required><button type="submit" class="btn btn-warning w-100 fw-bold">SIMPAN</button></form></div></div></div></div>

    <div class="modal fade" id="modalTambah" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body"><h6 class="fw-bold mb-3">TAMBAH/EDIT ANGGOTA</h6><form id="fAdd"><input type="hidden" id="editMemberId"><textarea id="n" class="form-control mb-2" style="height:100px" placeholder="Nama Anggota (Pisahkan enter)"></textarea><select id="k" class="form-select mb-3"><option value="Driver">Driver</option><option value="Helper">Helper</option></select><button type="submit" class="btn btn-warning w-100 fw-bold">SIMPAN</button></form></div></div></div></div>

    <div class="modal fade" id="modalKonfirmasiHapus" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-body p-4 text-center"><div class="mb-3" style="font-size: 2rem;">‚ö†Ô∏è</div><h6 class="fw-bold mb-4">Hapus data ini?</h6><div class="d-flex gap-2"><button type="button" class="btn btn-dark w-100" data-bs-dismiss="modal">BATAL</button><button type="button" class="btn btn-danger w-100" onclick="eksekusiHapus()">HAPUS</button></div></div></div></div></div>

    <div class="modal fade" id="modalKonfirmasiLog" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-body p-4 text-center"><div class="mb-3" style="font-size: 2rem;">üóëÔ∏è</div><h6 class="fw-bold mb-4">BERSIHKAN LOG?</h6><div class="d-flex gap-2"><button type="button" class="btn btn-dark w-100" data-bs-dismiss="modal">BATAL</button><button type="button" class="btn btn-danger w-100" onclick="eksekusiHapusLog()">HAPUS</button></div></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const CLOUD_URL = 'https://script.google.com/macros/s/AKfycbxGqn9fddYzeOONKISBo6uc6TT_osSkJ10J-20pLtSSQIAUXg6DfwY8f6yYUa6opPYH/exec';
        const APP_PIN = "0000";
        let DB_DRIVER = [], DB_HELPER = [], DB_TRANSAKSI = [], DB_LOGS = [];
        let pendingAction = null, pendingParams = null, currentContext = { type: '', id: null, idx: null };

        function setTheme(t) { document.body.setAttribute('data-theme', t); localStorage.setItem('delta8_theme', t); document.querySelectorAll('.theme-dot').forEach(d => d.classList.remove('active')); if (document.getElementById('dot-' + t)) document.getElementById('dot-' + t).classList.add('active'); }
        function toggleCol(id) { const el = document.getElementById(id); el.classList.toggle('show'); document.getElementById(id.split('-')[0] + '-icon').innerText = el.classList.contains('show') ? '‚ñ≤' : '‚ñº'; }

        window.onclick = function(e) {
            const menu = document.getElementById('actionMenu');
            const btn = e.target.closest('.btn-aksi-trigger');
            if (btn) {
                const rect = btn.getBoundingClientRect();
                currentContext = { type: btn.dataset.type, id: btn.dataset.id || null, idx: btn.dataset.idx || null };
                menu.style.display = 'block'; menu.style.top = (rect.bottom + window.scrollY) + 'px'; menu.style.left = (rect.left + window.scrollX - 80) + 'px';
                return;
            }
            if (e.target.closest('.status-toggle')) {
                const tgl = e.target.closest('.status-toggle');
                askAuth('toggle', { id: tgl.dataset.id, kat: tgl.dataset.kat, y: tgl.dataset.y, m: tgl.dataset.m });
            }
            if (!e.target.closest('#actionMenu')) menu.style.display = 'none';
        };

        function doEdit() { document.getElementById('actionMenu').style.display = 'none'; askAuth('edit_trigger'); }
        function doDelete() { document.getElementById('actionMenu').style.display = 'none'; new bootstrap.Modal('#modalKonfirmasiHapus').show(); }
        function eksekusiHapus() { bootstrap.Modal.getInstance('#modalKonfirmasiHapus').hide(); askAuth('delete_trigger'); }

        function askAuth(type, params = null) {
            pendingAction = type; pendingParams = params;
            document.getElementById('inputPIN').value = "";
            document.getElementById('inputEditorName').value = localStorage.getItem('delta8_editor') || "";
            bootstrap.Modal.getOrCreateInstance('#modalVerifyAuth').show();
        }

        function checkAuth() {
            const pin = document.getElementById('inputPIN').value, editor = document.getElementById('inputEditorName').value.trim();
            if (pin !== APP_PIN || editor.length < 2) return;
            localStorage.setItem('delta8_editor', editor.toUpperCase());
            bootstrap.Modal.getInstance('#modalVerifyAuth').hide();
            setTimeout(executeAction, 300);
        }

        function executeAction() {
            if (pendingAction === 'tambah') { 
                document.getElementById('fAdd').reset(); 
                document.getElementById('editMemberId').value = ""; 
                bootstrap.Modal.getOrCreateInstance('#modalTambah').show(); 
            } else if (pendingAction === 'catat') { 
                document.getElementById('fTrans').reset(); 
                document.getElementById('editTransIdx').value = ""; 
                document.getElementById('trans_date').valueAsDate = new Date(); 
                bootstrap.Modal.getOrCreateInstance('#modalCatat').show(); 
            } else if (pendingAction === 'download') {
                downloadFinancialPDF();
            } else if (pendingAction === 'edit_trigger') {
                if (currentContext.type === 'member') {
                    const p = [...DB_DRIVER, ...DB_HELPER].find(x => x.id == currentContext.id);
                    document.getElementById('editMemberId').value = p.id; 
                    document.getElementById('n').value = p.nama;
                    document.getElementById('k').value = DB_DRIVER.find(x => x.id == currentContext.id) ? 'Driver' : 'Helper';
                    bootstrap.Modal.getOrCreateInstance('#modalTambah').show();
                } else {
                    const t = DB_TRANSAKSI[currentContext.idx];
                    document.getElementById('editTransIdx').value = currentContext.idx;
                    document.getElementById('trans_type').value = t.tp; 
                    document.getElementById('trans_date').value = t.d;
                    document.getElementById('trans_source').value = t.p; 
                    document.getElementById('trans_ket').value = t.k;
                    document.getElementById('trans_val').value = t.v;
                    bootstrap.Modal.getOrCreateInstance('#modalCatat').show();
                }
            } else if (pendingAction === 'delete_trigger') {
                if (currentContext.type === 'member') {
                    const isDriver = DB_DRIVER.some(x => x.id == currentContext.id);
                    const kat = isDriver ? 'DRIVER' : 'HELPER';
                    const p = [...DB_DRIVER, ...DB_HELPER].find(x => x.id == currentContext.id);
                    addLog("Hapus anggota", `${kat} - ${p.nama}`);
                    DB_DRIVER = DB_DRIVER.filter(x => x.id != currentContext.id); 
                    DB_HELPER = DB_HELPER.filter(x => x.id != currentContext.id);
                } else {
                    const t = DB_TRANSAKSI[currentContext.idx];
                    addLog("Hapus transaksi", `TRANSAKSI - ${t.tp.toUpperCase()} - ${t.p} - ${t.k || '-'}`);
                    DB_TRANSAKSI.splice(currentContext.idx, 1);
                }
                syncAll();
            } else if (pendingAction === 'toggle') {
                let p = (pendingParams.kat === 'Driver' ? DB_DRIVER : DB_HELPER).find(x => x.id == pendingParams.id);
                if (!p.status[pendingParams.y]) p.status[pendingParams.y] = {};
                p.status[pendingParams.y][pendingParams.m] = !p.status[pendingParams.y][pendingParams.m];
                
                const isLunas = p.status[pendingParams.y][pendingParams.m];
                const statusIcon = isLunas ? "‚úÖ - LUNAS" : "‚ùå - BATAL";
                const formatBulan = pendingParams.m.toString().padStart(2, '0');
                
                addLog("Iuran", `${pendingParams.kat.toUpperCase()} - ${p.nama} - ${formatBulan}/${pendingParams.y} - [${statusIcon}]`);
                syncAll();
            }
        }

        async function loadFromCloud() {
    document.getElementById('sync-status').innerText = "‚è≥ MEMUAT DATA...";
    try {
        const res = await fetch(CLOUD_URL + "?action=read"); 
        const data = await res.json();
        
        // Memastikan data yang diterima tidak kosong
        DB_DRIVER = data.driver || []; 
        DB_HELPER = data.helper || []; 
        DB_TRANSAKSI = data.transaksi || []; 
        DB_LOGS = data.logs || [];
        
        render(); 
        document.getElementById('sync-status').innerText = "‚òÅÔ∏è TERHUBUNG";
    } catch (e) { 
        document.getElementById('sync-status').innerText = "‚òÅÔ∏è TERPUTUS"; 
        render(); 
    }
}


        async function syncAll() {
    render(); 
    // Memberikan indikasi visual di HP bahwa data sedang dikirim
    document.getElementById('sync-status').innerText = "‚è≥ MENYIMPAN...";
    
    try {
        await fetch(CLOUD_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                driver: DB_DRIVER, 
                helper: DB_HELPER, 
                transaksi: DB_TRANSAKSI, 
                logs: DB_LOGS 
            }) 
        });
        // Jika berhasil, status kembali ke TERHUBUNG
        document.getElementById('sync-status').innerText = "‚òÅÔ∏è TERHUBUNG";
    } catch (e) {
        // Jika gagal (misal: sinyal buruk), status akan memberitahu Anda
        document.getElementById('sync-status').innerText = "‚ö†Ô∏è GAGAL SINKRON";
        console.error("Error Sync:", e);
    }
}

        function addLog(aksi, ket) {
            const d = new Date(), pad = (n) => n.toString().padStart(2, '0');
            const time = `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()} ${pad(d.getHours())}.${pad(d.getMinutes())}`;
            DB_LOGS.unshift({ time, editor: localStorage.getItem('delta8_editor'), aksi: aksi.toUpperCase(), ket: ket.toUpperCase() });
        }

        function clearLogs() { new bootstrap.Modal('#modalKonfirmasiLog').show(); }
        function eksekusiHapusLog() { bootstrap.Modal.getInstance('#modalKonfirmasiLog').hide(); addLog("SYSTEM", "BERSIHKAN SEMUA LOG"); DB_LOGS = []; syncAll(); }

                function render() {
            const gd = document.getElementById('grid-driver'), gh = document.getElementById('grid-helper'), hi = document.getElementById('hist'), lg = document.getElementById('log-list');
            gd.innerHTML = gh.innerHTML = hi.innerHTML = lg.innerHTML = '';
            const m = parseInt(document.getElementById('selMonth').value), y = parseInt(document.getElementById('selYear').value);
            let sAwal = calculatePastBalance(m, y), cIuran = 0, cLainnya = 0, cOut = 0;

            // Memasukkan logika pengurutan A-Z sebelum data digambar
            const sortedDrivers = [...DB_DRIVER].sort((a, b) => a.nama.localeCompare(b.nama));
            const sortedHelpers = [...DB_HELPER].sort((a, b) => a.nama.localeCompare(b.nama));

            const draw = (list, target, kat) => {
                list.forEach((p, idx) => {
                    let count = 0, cells = ''; if (!p.status) p.status = {};
                    for (let i = 1; i <= 12; i++) {
                        let s = p.status[y]?.[i] || false; if (s) { count++; if (i === m) cIuran += 25000; }
                        cells += `<td class="status-toggle ${s ? 'text-success' : 'text-danger'}" data-id="${p.id}" data-kat="${kat}" data-y="${y}" data-m="${i}">${s ? '‚úÖ' : '‚ùå'}</td>`;
                    }
                    target.innerHTML += `<tr><td class="no-col">${idx + 1}</td><td class="name-col">${p.nama}</td>${cells}<td class="text-center-force">${count}/12</td><td class="col-aksi-center"><div class="btn-aksi-trigger" data-type="member" data-id="${p.id}">‚ãÆ</div></td></tr>`;
                });
            };

            // Menggunakan data yang sudah terurut
            draw(sortedDrivers, gd, 'Driver'); 
            draw(sortedHelpers, gh, 'Helper');

            DB_TRANSAKSI.forEach((x, idx) => {
                let d = new Date(x.d);
                if (d.getFullYear() === y && (d.getMonth() + 1) === m) {
                    if (x.tp === 'Pemasukan') cLainnya += x.v; else cOut += x.v;
                    hi.innerHTML += `<tr><td class="text-center">${x.d.split('-').reverse().join('/')}</td><td class="fw-bold ${x.tp == 'Pemasukan' ? 'text-success' : 'text-danger'} text-center">${x.tp.toUpperCase()}</td><td>${x.p}</td><td>${x.k || '-'}</td><td class="fw-bold text-end">Rp ${x.v.toLocaleString()}</td><td class="col-aksi-center"><div class="btn-aksi-trigger" data-type="trans" data-idx="${idx}">‚ãÆ</div></td></tr>`;
                }
            });

            DB_LOGS.slice(0, 50).forEach(l => { lg.innerHTML += `<tr><td>${l.time}</td><td>${l.editor}</td><td><small class="badge bg-dark">${l.aksi}</small></td><td>${l.ket}</td></tr>`; });

            document.getElementById('s-awal').innerText = "Rp " + sAwal.toLocaleString();
            document.getElementById('in').innerText = "Rp " + cIuran.toLocaleString();
            document.getElementById('out').innerText = "Rp " + cOut.toLocaleString();
            document.getElementById('bal').innerText = "Rp " + cLainnya.toLocaleString();
            document.getElementById('s-akhir').innerText = "Rp " + (sAwal + cIuran + cLainnya - cOut).toLocaleString();
        }

        function calculatePastBalance(m, y) {
            let tIn = 0, tOut = 0;
            [...DB_DRIVER, ...DB_HELPER].forEach(p => { if (p.status) Object.keys(p.status).forEach(sy => { Object.keys(p.status[sy]).forEach(sm => { if (parseInt(sy) < y || (parseInt(sy) == y && parseInt(sm) < m)) if (p.status[sy][sm]) tIn += 25000; }); }); });
            DB_TRANSAKSI.forEach(x => { let d = new Date(x.d); if (d.getFullYear() < y || (d.getFullYear() == y && (d.getMonth() + 1) < m)) if (x.tp === 'Pemasukan') tIn += x.v; else tOut += x.v; });
            return tIn - tOut;
        }

        document.getElementById('fAdd').onsubmit = (e) => {
            e.preventDefault(); const id = document.getElementById('editMemberId').value;
            const kat = document.getElementById('k').value.toUpperCase(); 
            const n = document.getElementById('n').value.toUpperCase();
            if (id) { 
                let p = [...DB_DRIVER, ...DB_HELPER].find(x => x.id == id); 
                const oldName = p.nama;
                p.nama = n;
                addLog("Edit anggota", `${kat} - ${oldName} => ${n}`);
            } else { 
                n.split('\n').filter(x => x.trim()).forEach(nm => { 
                    let p = { id: "ID-"+Date.now()+Math.random().toString(36).substr(2,3), nama: nm.trim(), status: {} }; 
                    if (kat === 'DRIVER') DB_DRIVER.push(p); else DB_HELPER.push(p); 
                    addLog("Tambah anggota", `${kat} - ${nm.trim()}`);
                });
            }
            syncAll(); bootstrap.Modal.getInstance('#modalTambah').hide();
        };

        document.getElementById('fTrans').onsubmit = (e) => {
            e.preventDefault(); const f = new FormData(e.target), idx = document.getElementById('editTransIdx').value;
            const d = { tp: f.get('tp'), d: f.get('d'), p: f.get('p').toUpperCase(), k: f.get('k').toUpperCase(), v: parseInt(f.get('v')) };
            if (idx !== "") {
                const old = DB_TRANSAKSI[idx];
                let changes = [];
                if(old.tp !== d.tp) changes.push(`TIPE: ${old.tp}=>${d.tp}`);
                if(old.p !== d.p) changes.push(`SUMBER: ${old.p}=>${d.p}`);
                if(old.k !== d.k) changes.push(`KET: ${old.k}=>${d.k}`);
                if(old.v !== d.v) changes.push(`NOM: ${old.v}=>${d.v}`);
                DB_TRANSAKSI[idx] = d;
                addLog("Edit transaksi", `TRANSAKSI - ${d.tp.toUpperCase()} - ${d.p} - ${changes.join(', ')}`);
            } else {
                DB_TRANSAKSI.push(d);
                addLog("Tambah transaksi", `TRANSAKSI - ${d.tp.toUpperCase()} - ${d.p} - ${d.k || '-'}`);
            }
            syncAll(); bootstrap.Modal.getInstance('#modalCatat').hide();
        };

        async function downloadFinancialPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const mText = document.getElementById('selMonth').options[document.getElementById('selMonth').selectedIndex].text.toUpperCase();
            const yText = document.getElementById('selYear').value;
            const editorName = (localStorage.getItem('delta8_editor') || "SUPER ADMIN KAS").toUpperCase();

            const blackBg = [15, 15, 15]; 
            const goldAccent = [212, 175, 55]; 
            const whiteText = [255, 255, 255];
            const borderColor = [0, 0, 0]; 
            const pureBlack = [0, 0, 0]; 
            const stampRed = [180, 0, 0]; 

            doc.setFillColor(blackBg[0], blackBg[1], blackBg[2]);
            doc.rect(0, 0, 210, 45, 'F');
            doc.setDrawColor(goldAccent[0], goldAccent[1], goldAccent[2]);
            doc.setLineWidth(1);
            doc.line(15, 33, 195, 33);

            doc.setTextColor(goldAccent[0], goldAccent[1], goldAccent[2]);
            doc.setFont("times", "bold"); doc.setFontSize(24);
            doc.text("DATA RINCIAN UANG KAS", 105, 20, { align: "center" });
            doc.setTextColor(whiteText[0], whiteText[1], whiteText[2]);
            doc.setFontSize(12); doc.setFont("times", "normal");
            doc.text("DRIVER HELPER DELTA8 & LOGISTICS", 105, 28, { align: "center" });
            doc.setFontSize(11); doc.setFont("times", "italic");
            doc.text(`Periode: ${mText} ${yText}`, 105, 40, { align: "center" });

            const sAwal = document.getElementById('s-awal').innerText;
            const sAkhir = document.getElementById('s-akhir').innerText;
            const iuran = document.getElementById('in').innerText;
            const keluar = document.getElementById('out').innerText;
            const lainnya = document.getElementById('bal').innerText;

            const drawCard = (x, y, w, h, title, value, bgColor, txtColor = [0,0,0]) => {
                doc.setDrawColor(0); doc.setLineWidth(0.5);
                doc.setFillColor(bgColor[0], bgColor[1], bgColor[2]);
                doc.roundedRect(x, y, w, h, 3, 3, 'FD'); 
                doc.setTextColor(txtColor[0], txtColor[1], txtColor[2]);
                doc.setFontSize(16); doc.setFont("times", "bold");
                doc.text(title, x + (w / 2), y + 9, { align: "center" });
                doc.setFontSize(20); doc.setFont("times", "bold");
                doc.text(value, x + (w / 2), y + 21, { align: "center" });
            };

            drawCard(15, 60, 88, 30, "Saldo Awal", sAwal, [255, 220, 100]); 
            drawCard(107, 60, 88, 30, "Total Iuran Anggota (+)", iuran, [180, 230, 180]); 
            drawCard(15, 95, 88, 30, "Pemasukan Lainnya (+)", lainnya, [180, 230, 180]); 
            drawCard(107, 95, 88, 30, "Total Pengeluaran (-)", keluar, [255, 180, 180]); 
            drawCard(15, 130, 180, 35, "SALDO AKHIR (TOTAL BALANCE)", sAkhir, [30, 60, 120], [255, 255, 255]); 
            
            doc.setTextColor(pureBlack[0], pureBlack[1], pureBlack[2]);
            doc.setFontSize(14); doc.setFont("times", "bold");
            doc.text("RIWAYAT TRANSAKSI", 105, 172, { align: "center" }); 

            const transData = [];
            document.querySelectorAll('#hist tr').forEach(row => {
                const cols = row.querySelectorAll('td');
                if(cols.length > 0) {
                    transData.push([cols[0].innerText, cols[1].innerText, cols[2].innerText, cols[3].innerText, cols[4].innerText]);
                }
            });

            doc.autoTable({
                startY: 177,
                margin: { left: 15, right: 15 }, 
                head: [['TANGGAL', 'TIPE', 'SUMBER', 'KETERANGAN', 'JUMLAH']],
                body: transData,
                theme: 'grid',
                headStyles: { fillColor: blackBg, textColor: whiteText, fontStyle: 'bold', halign: 'center', lineWidth: 0.2, lineColor: borderColor, fontSize: 10, minCellHeight: 6 },
                styles: { font: 'times', fontSize: 9, textColor: pureBlack, cellPadding: 0.8, minCellHeight: 4, valign: 'middle', lineWidth: 0.1, lineColor: borderColor },
                columnStyles: { 0: { halign: 'center' }, 1: { halign: 'center' }, 4: { halign: 'right', fontStyle: 'bold' } },
                alternateRowStyles: { fillColor: [245, 245, 245] }
            });

            const finalY = doc.lastAutoTable.finalY + 15;
            const rightPos = 195; 

            if (finalY < 250) {
                doc.setTextColor(pureBlack[0], pureBlack[1], pureBlack[2]);
                doc.setFont("times", "normal"); doc.setFontSize(12);
                doc.text("Diterbitkan Oleh,", rightPos - 25, finalY + 40, { align: "center" });
                
                const sX = rightPos - 45; 
                const sY = finalY + 52;
                doc.setDrawColor(stampRed[0], stampRed[1], stampRed[2]);
                doc.setLineWidth(0.8);
                doc.circle(sX, sY, 13, 'S'); 
                doc.setLineWidth(0.3);
                doc.circle(sX, sY, 11, 'S'); 
                doc.line(sX - 9, sY - 2, sX + 9, sY - 2); 
                doc.line(sX - 9, sY + 2.5, sX + 9, sY + 2.5); 
                
                doc.setTextColor(stampRed[0], stampRed[1], stampRed[2]);
                doc.setFontSize(5); doc.setFont("helvetica", "bold");
                doc.text("PENGURUS  KAS", sX, sY - 4.0, { align: "center" });
                doc.setFontSize(8);
                doc.text("SNJ DELTA 8", sX, sY + 1, { align: "center" });
                doc.setFontSize(5);
                doc.text("DRIVER HELPER", sX, sY + 5.5, { align: "center" });

                doc.setFont("courier", "bolditalic"); doc.setFontSize(14);
                doc.setTextColor(20, 40, 100); 
                doc.text(editorName, rightPos - 25, finalY + 53, { align: "center" });

                doc.setTextColor(pureBlack[0], pureBlack[1], pureBlack[2]);
                doc.setFont("times", "bold"); doc.setFontSize(11);
                doc.text("(       Pengurus Uang KAS       )", rightPos, finalY + 65, { align: "right" }); 
                doc.text("__________________________", rightPos, finalY + 66, { align: "right" }); 
            }

            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(9); doc.setTextColor(100);
                // Menukar urutan: Waktu dicetak di baris atas, Supported di baris bawah
                doc.text(`Official Document Driver Helper Delta 8 | Dicetak: ${new Date().toLocaleString()} | Halaman ${i} dari ${pageCount}`, 105, 285, { align: "center" } );
                doc.setFontSize(8); doc.setTextColor(120);
                doc.text(`--<{SUPPORTED BY : MANCUNG_168}>--`, 105, 290, { align: "center" } );
            }

            doc.save(`LAPKAS_${editorName}_${mText}.pdf`);
        }

        window.onload = () => {
            setTheme(localStorage.getItem('delta8_theme') || 'luxury');
            const sm = document.getElementById('selMonth'), sy = document.getElementById('selYear'), now = new Date();
            const nm = ["", "Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            for (let i = 1; i <= 12; i++) sm.innerHTML += `<option value="${i}" ${i === (now.getMonth() + 1) ? 'selected' : ''}>${nm[i]}</option>`;
            for (let i = 2024; i <= 2050; i++) sy.innerHTML += `<option value="${i}" ${i === now.getFullYear() ? 'selected' : ''}>${i}</option>`;
            loadFromCloud();
        };
    </script>
</body>
</html>
